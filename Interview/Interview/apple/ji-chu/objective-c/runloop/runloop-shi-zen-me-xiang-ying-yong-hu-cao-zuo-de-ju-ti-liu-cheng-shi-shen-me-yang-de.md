# Runloop 是怎么响应用户操作的， 具体流程是什么样的？

`RunLoop` 是 iOS 和 macOS 系统中用于处理和管理事件循环的核心机制之一，它负责接收和分发各种输入源（如触摸事件、定时器、网络请求等）。`RunLoop` 通过不断地运行事件循环，确保应用程序能够响应用户的操作（例如点击、滑动、输入等）。具体来说，`RunLoop` 通过以下流程处理和响应用户操作：

#### 1. `RunLoop` 的基本结构

`RunLoop` 是一个循环，它在没有事件时会让线程休眠，而当有事件需要处理时，它会被唤醒并开始执行对应的处理任务。其工作流程大致如下：

* 等待输入源（例如用户触摸事件、定时器、端口、网络事件等）。
* 当事件发生时，`RunLoop` 被唤醒，处理该事件。
* 事件处理完成后，`RunLoop` 再次进入休眠状态，直到下一个事件触发。

#### 2. `RunLoop` 处理用户操作的具体流程

**2.1 用户操作到 `RunLoop` 响应的流程**

当用户执行某个操作（例如点击屏幕或拖动视图）时，整个事件处理过程通常如下：

1. **用户触摸事件产生**：
   * 用户的触摸（点击、滑动等）事件会通过硬件传递给操作系统，操作系统将这些事件发送到应用的事件队列中。
2. **系统唤醒 `RunLoop` 进行事件处理**：
   * 当事件到来时，`RunLoop` 会被唤醒，开始检查并处理事件队列中的事件。
   * iOS 应用的主线程的 `RunLoop` 始终在运行，并负责接收和处理所有 UI 相关的事件。
3. **事件分发**：
   * `RunLoop` 检查事件的类型，将其分发给合适的处理函数。对于用户的触摸事件，事件会被传递给 `UIKit` 处理。
   * `UIKit` 会根据视图层次结构找到最合适的视图（例如，触摸点所在的 `UIButton`）来响应用户的交互。
4. **视图的事件处理**：
   * 目标视图（如 `UIButton`）接收到触摸事件后，调用相应的回调函数来响应用户的操作。例如，按钮的 `touchUpInside` 事件可能会触发某个方法。
   * 该方法的执行是在主线程上完成的，因为主线程的 `RunLoop` 负责管理和分发所有的 UI 事件。
5. **RunLoop 进入休眠**：
   * 当事件处理完成，`RunLoop` 重新进入休眠状态，直到有新的事件或输入源出现。

**2.2 具体流程的图解**

整个过程可以总结为以下几个步骤：

1. 用户点击或触摸屏幕。
2. 系统接收到硬件事件，并将事件放入应用程序的事件队列中。
3. `RunLoop` 被唤醒，开始处理事件队列中的事件。
4. `RunLoop` 将事件分发给 `UIKit`，并根据视图层次结构找到最合适的响应对象（如 `UIView` 或 `UIButton`）。
5. 响应对象处理触摸事件，并执行相应的动作（如回调方法）。
6. 事件处理结束后，`RunLoop` 再次进入休眠状态。

#### 3. `RunLoop` 的运行模式

`RunLoop` 支持不同的运行模式，来管理和区分不同类型的事件。主线程上的 `RunLoop` 通常以 `NSDefaultRunLoopMode` 运行，但在某些情况下（如用户拖动 `UIScrollView` 时），会切换到 `UITrackingRunLoopMode`。

常见的 `RunLoop` 模式包括：

* **`NSDefaultRunLoopMode`**：主线程默认的运行模式，用于处理普通事件，如定时器、用户操作。
* **`UITrackingRunLoopMode`**：专门用于处理用户界面的交互事件，例如滑动、滚动。
* **`NSRunLoopCommonModes`**：一组常见模式的集合，包括 `NSDefaultRunLoopMode` 和 `UITrackingRunLoopMode`，当你需要在多个模式下执行某些操作时，可以将它们加入 `NSRunLoopCommonModes`。

#### 4. `RunLoop` 的输入源和事件类型

`RunLoop` 通过监听不同的输入源（Input Source）来处理事件，输入源分为两类：

1. **基于端口的输入源（Port-Based Sources）**：这些输入源用于处理系统级别的事件，如 `mach port` 事件、`CFSocket` 等。
2. **基于定时器的输入源（Timer Sources）**：如 `NSTimer`，用于调度周期性或延迟的任务。

此外，`RunLoop` 还支持以下两类事件处理：

* **定时器事件（Timers）**：当定时器到期时，`RunLoop` 会执行定时器回调。
* **异步事件**：比如网络回调、`GCD` 任务等，通常由 `RunLoop` 处理。

#### 5. `RunLoop` 处理用户操作的核心机制

`RunLoop` 的工作机制是基于事件驱动的，每次循环时，它会处理队列中的一个或多个事件。流程如下：

1. **检查输入源**：`RunLoop` 检查是否有输入源事件需要处理（例如用户的触摸事件、系统端口消息等）。
2. **处理事件**：如果有事件存在，`RunLoop` 执行相应的事件处理程序。
3. **等待新事件**：如果没有事件需要处理，`RunLoop` 会让线程进入休眠状态，以节省资源，直到有新的事件发生。
4. **唤醒并循环**：当有新的事件（如定时器或用户操作）触发时，`RunLoop` 被唤醒，重新进入事件处理流程。

#### 6. `RunLoop` 与用户交互的优化

* **`RunLoop` 优化性能**：通过 `RunLoop`，主线程可以在没有事件需要处理时进入休眠，从而避免 CPU 资源的浪费，保持应用的高效运行。
* **避免阻塞主线程**：长时间的阻塞任务（如网络请求、文件处理等）会导致 `RunLoop` 无法及时处理 UI 事件，从而引发卡顿或无响应。因此，这类任务通常会放到后台线程中进行处理，通过 `RunLoop` 机制将结果回调到主线程。

#### 总结

`RunLoop` 是 iOS 应用程序中处理用户交互和系统事件的关键机制。它不断循环、监听和处理各种事件，如用户的触摸操作、定时器回调、异步任务等。通过 `RunLoop` 的事件驱动模式，应用可以在不消耗过多资源的情况下响应用户操作，并确保用户界面平滑和流畅。
