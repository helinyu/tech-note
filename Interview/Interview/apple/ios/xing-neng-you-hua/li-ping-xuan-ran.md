# 离屏渲染

### <mark style="color:red;">离屏渲染消耗性能, 为什么需要离屏渲染呢？</mark>

在 iOS 中，设置圆角（如 `layer.cornerRadius`）可能会导致离屏渲染（Offscreen Rendering），这会带来性能消耗。了解为何会发生离屏渲染，可以帮助你优化性能。

#### 为什么需要离屏渲染？

离屏渲染的需求源于 iOS 渲染管线的工作方式。一般来说，iOS 在渲染视图时会把渲染操作直接映射到 GPU 层。然而，某些图形效果，如圆角、阴影、透明度、模糊等，可能无法在硬件层直接完成，而是需要在渲染之前将视图的内容“提前处理”，这时就需要离屏渲染。

具体来说：

1. **圆角（Corner Radius）**：当设置 `cornerRadius` 属性并且图层有遮罩（mask）、阴影（shadow）等效果时，会触发离屏渲染。
2. **遮罩（Mask）**：设置 `mask` 属性时，iOS 会在离屏缓冲区中创建遮罩效果。
3. **阴影（Shadow）**：如果图层设置了阴影效果（`shadowOpacity`、`shadowRadius` 等），iOS 会在离屏缓冲区中生成阴影。
4. **混合图层（Blend Layer）**：如 `shouldRasterize` 属性、透明图层（透明度小于 1.0）等也会触发离屏渲染。
5. **其他效果**：毛玻璃效果、复杂的图形变换等，也会触发离屏渲染。这是因为 GPU 需要对这些效果进行额外的图形处理，可能导致创建离屏缓冲区。

#### 为什么离屏渲染会影响性能？

离屏渲染通常意味着：

* **额外的图形缓冲区**：离屏渲染需要额外的内存空间来保存视图的渲染结果，这会消耗系统资源。
* **额外的绘制步骤**：首先需要将视图的内容渲染到一个缓冲区，再应用圆角或其他效果，最终将结果渲染到屏幕。这增加了渲染的复杂性和时间。
* **GPU负载增加**：由于涉及额外的图形操作，GPU 需要处理更多的渲染指令，尤其是在有大量视图需要渲染的情况下，可能导致性能下降。

#### 如何减少离屏渲染的影响？

1. **避免过多的圆角**：尽量减少需要圆角的视图，尤其是层级较深的视图。
2. **硬件加速**：使用 `cornerRadius` 仅在必要时，避免频繁更改圆角半径。
3. **优化布局**：合理布局视图，避免在滚动时对大量视图进行离屏渲染。
4. **使用 `maskToBounds`**：如果你仅需要裁剪视图（如圆形头像），而不是应用复杂的效果，可以通过设置 `maskToBounds` 来直接裁剪，而不触发离屏渲染。

总的来说，离屏渲染带来的性能影响主要是因为其涉及到额外的渲染操作和内存使用，因此需要谨慎处理可能触发这些效果的视图。
