# 架构

WebKit 是一个用于渲染网页内容的开源浏览器引擎，最初由 Apple 从 KHTML 和 KJS 发展而来，主要用于 Safari 浏览器以及 iOS 和 macOS 上的应用（例如 `WKWebView` 和 `UIWebView`）。WebKit 的架构非常复杂，涉及多个组件和模块，下面是 WebKit 的主要架构概览：

#### WebKit 架构主要分为四大部分：

1. **WebCore**（核心渲染引擎）
2. **JavaScriptCore**（JavaScript 引擎）
3. **网络层（Network Layer）**
4. **平台抽象层（Platform Layer）**

#### 1. **WebCore（核心渲染引擎）**

WebCore 是 WebKit 的核心部分，负责处理 HTML、CSS、SVG 和其他网页相关的文档和内容，主要功能如下：

* **HTML 解析**：将 HTML 转换为 DOM（Document Object Model）树，以表示网页的结构。
* **CSS 解析和样式计算**：处理 CSS，解析样式表，并应用样式规则，以确定如何渲染页面元素。
* **布局和渲染**：负责布局引擎（Layout Engine），它根据 DOM 和样式信息，计算页面各元素的位置和尺寸，并将这些元素渲染到屏幕上。
* **事件处理**：负责用户交互的事件（如点击、滚动、触摸等）的处理和分发。
* **SVG 支持**：支持渲染 SVG 图形，确保网页中嵌入的矢量图形正确显示。
* **多媒体支持**：包括视频、音频等媒体元素的解析和显示。

#### 2. **JavaScriptCore（JS 引擎）**

JavaScriptCore 是 WebKit 中的 JavaScript 引擎，负责执行和解释 JavaScript 代码。它与 WebCore 协同工作，以实现网页中的动态行为和交互。它的主要功能如下：

* **JavaScript 解析**：将 JavaScript 源代码解析成 AST（抽象语法树）。
* **字节码生成**：将 JavaScript 转换为字节码，交给虚拟机执行。
* **JIT 编译**：通过即时编译（Just-In-Time Compilation）将字节码转换为机器码，以提升执行效率。
* **垃圾回收**：管理内存分配和回收，清理不再使用的对象，保证内存的高效利用。

#### 3. **网络层（Network Layer）**

网络层是 WebKit 与互联网交互的部分，负责下载和上传网页内容及资源。它与操作系统的网络 API 紧密结合，主要处理：

* **HTTP/HTTPS 请求**：发送网页请求，并接收服务器的响应数据。
* **缓存管理**：管理缓存资源，如网页资源、图片、脚本文件等，以提升加载速度。
* **Cookie 管理**：存储和管理网页的 Cookie，处理登录状态和用户偏好等信息。
* **安全管理**：通过 SSL/TLS 处理 HTTPS 安全连接，管理证书验证和加密通信。

#### 4. **平台抽象层（Platform Layer）**

平台抽象层是 WebKit 为跨平台运行而设计的接口层，它抽象了与操作系统、硬件交互的细节，使得 WebKit 能在不同的操作系统（如 macOS、iOS、Windows、Linux 等）上运行。主要涉及：

* **图形绘制（Graphics Layer）**：WebKit 通过平台抽象层与操作系统的图形系统交互，如 macOS 使用 Core Graphics，Windows 使用 Direct2D，Linux 使用 Cairo。它负责将页面渲染到屏幕上。
* **字体渲染（Font Rendering）**：管理字体的渲染和排版，支持多种字体格式和文本样式。
* **硬件加速**：支持 GPU 加速渲染，优化动画、视频、图像等重度计算操作的性能。
* **输入事件**：处理来自键盘、鼠标、触摸屏等硬件设备的输入事件。

#### WebKit 的工作流程

当浏览器或应用程序加载一个网页时，WebKit 的各个组件协同工作，完成如下流程：

1. **加载网页内容**：网络层发送 HTTP 请求，获取 HTML 文件及其资源（如 CSS、JavaScript、图片等）。
2. **HTML 解析**：WebCore 将 HTML 解析为 DOM 树，同时 CSS 也被解析，并与 DOM 结合生成渲染树。
3. **布局计算**：渲染树的每个节点根据 CSS 样式规则进行布局，确定元素的大小和位置。
4. **绘制渲染**：平台抽象层将渲染树的每个节点绘制到屏幕上，图像、文本、颜色等元素依次呈现。
5. **JavaScript 解析和执行**：JavaScriptCore 解析并执行 JavaScript，处理用户交互、动态内容和事件。
6. **页面更新**：如果页面有动态变化（如 JavaScript 修改了 DOM 结构），WebCore 重新计算布局并更新渲染。

#### WebKit 的多进程架构

在现代浏览器中，WebKit 使用多进程架构，尤其在 `WKWebView` 中体现得很明显：

* **UI 进程**：负责管理浏览器或应用程序的用户界面。
* **Web 内容进程**：处理网页的渲染、JavaScript 执行和资源加载，所有与 Web 内容相关的任务在这个独立进程中完成。
* **网络进程**：专门负责网络请求和资源加载，确保网页的下载与渲染分离，提升稳定性。

这种多进程架构的优点在于：

* 增强安全性，网页与应用程序隔离，避免恶意网页攻击主进程。
* 提高稳定性，即使网页崩溃，应用程序也不会被拖累。
* 优化性能，进程间资源隔离减少相互影响。

#### 总结

WebKit 的架构基于高度模块化设计，通过 WebCore 渲染引擎、JavaScriptCore 解释引擎、网络层和平台抽象层的协同工作，完成网页的解析、渲染和动态交互。WebKit 的多进程架构进一步提高了性能、安全性和稳定性，使其成为现代浏览器和 iOS/macOS 应用的基础。
